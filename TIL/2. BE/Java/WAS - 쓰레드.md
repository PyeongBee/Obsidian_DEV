WAS에 도착한 요청 메시지가 servelt까지는 어떻게 도달할까?
이를 답하기 위해 쓰레드가 등장한다!

### 쓰레드
- WAS에 도착한 요청 메시지를 처리한다
- 쓰레드가 없으면 JAVA WAS 실행 불가
- JAVA main 메서드를 실행하면, main 쓰레드가 실행
- 쓰레드는 한 번에 코드 한 줄만 수행
- 동시 처리가 필요하면 쓰레드를 추가 생성

#### 단일 쓰레드 - 단일 요청 처리 과정
요청 -> WAS 쓰레드 할당 -> 요청 처리 -> 응답 -> 쓰레드 휴식

#### 단일 쓰레드 - 다중 요청 처리 과정
![[Pasted image 20240705122104.png]]
- WAS의 쓰레드가 요청1을 처리 중일 때, 요청2가 오면 쓰레드 할당까지 대기
- 만약 요청1이 처리 지연되면, 요청2도 계속해서 처리 지연

##### 요청마다 신규 쓰레드를 생성하는 것은 어떨까?
- 리소스(CPU, 메모리)가 허용하는 한 모든 동시 요청을 처리 가능하다
- 하나의 쓰레드가 지연되어도, 다른 쓰레드는 정상 동작
- **BUT!** 쓰레드 생성 비용은 매우 비싸다
- 쓰레드는 컨텍스트 스위칭 비용이 발생하기 때문에, 쓰레드가 너무 많아지면 응답 속도가 느려진다
- 또한, 쓰레드 생성에 제한이 없기 때문에, 너무 많은 쓰레드가 생성되면 서버가 터질 수 있다

### 쓰레드 풀
그래서, 이 문제를 보완하기 위해 쓰레드 풀이 등장!
- 필요한 쓰레드를 서버가 터지지 않을 정도의 일정 수만큼 미리 생성을 해두고, 요청이 올 때마다 쓰레드 풀에서 쓰레드를 꺼내 사용
- 톰캣의 쓰레드풀 기본 설정은 쓰레드 200개
- 최대 쓰레드가 모두 사용중이라면?
	- 요청을 거절하거나, 일정 수만큼 대기할 수 있도록 설정 가능
- 쓰레드가 미리 생성되어있어서, 쓰레드 생성/종료에 따른 비용이 절약되어 응답이 빠르다

![[Pasted image 20240705123120.png]]

### 쓰레드풀을 활용한 멀티 쓰레드
- WAS는 여러 요청을 동시에 처리할 수 있도록 **스레드 풀**을 사용
- WAS가 메시지를 받으면 스레드 풀에서 가용한 스레드에 요청을 할당
- 만약 모든 스레드가 바쁘다면, 요청은 대기열에 들어가고 스레드에 할당될 때까지 대기
- 요청을 할당 받은 스레드는 요청을 읽고 파싱하여 적절한 서블릿으로 전달

#### WAS 튜닝 - 최대 쓰레드 수
- 너무 낮게 설정하면?
	- 트래픽이 많아도 서버는 안 터지겠지만, 사용자 속이 터지겠지
- 너무 높게 설정하면?
	- 트래픽이 많이 몰리면, 서버가 터지겠지
- 장애 발생시?
	- 클라우드 환경이면, scale-out부터 하고, 이후 WAS 튜닝
	- 클라우드가 아니면, 열심히 WAS 튜닝

